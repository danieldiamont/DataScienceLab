A Simulated Annealing Based Inexact Oracle for Wasserstein Loss Minimization

A. Theoretical Properties of Gibbs-OT

(t)

We develop quantitative concentration bounds for GibbsOT in a finite number of iterations in order to understand
the relationship between the temperature schedule and the
concentration progress. The analysis also guides us to adjust cooling schedule on-the-fly, as will be shown. Proofs
are provided in Supplement.
Preliminaries. Before characterizing the properties of
Gibbs-OT by Definition 1, we first give the analytic expression for p(zn+1 |zn ). Let G(·) : [ 1, 1] 7! [0, 1]
be the c.d.f. of standard exponential distribution. Because
(t+1)
(t)
Lj
< x by definition , 8i, gi
Mi,j < x, the
(t+1)

c.d.f. of Lj

|U(t) reads

m1
⇣
⌘ Y
(t+1)
Pr Lj
< x U(t) =
1

G

i=1
(t)

Likewise, the c.d.f. of Ui |L(t) reads
Pr

⇣

(t)
Ui

⌘

< x L(t) =

m2
Y

x

G

(t)

T (2t

Lj

1) /q

j

!

.

Lemma A.1. (i) Given 1  j  m2 and 1  t  N , let the
(t)
m1
1
sorted index of {Ui
Mi,j }m
i=1 be permutation { (i)}i=1
(t)
1
such that sequence {U (i) M (i),j }m
i=1 are monotonically
non-increasing. Define the auxiliary quantity
Qk 1
m1
X
(1 µk ) i=1 µi
(t) def.
,
(19)
Pk
j =
i=1 p (k)
k=1
where
1

def.

µi = exp

i=1 p (k)
T (2t)

h

U

(i+1)

U

1

j

def.

= exp

( Pk

h⇣
Mi,

j=1 q (j)
T (2t 1)

⇣

Mi,

(j+1)

+L
+

(t)
(j)

⌘

(t+1)
L (j)

)
⌘i

= 0 . Then, the conditional

m2

(1)

(j)

+L

(t)
(1)

+

(t) (2t 1)
i T

.

In particular, we denote (1) by Jit or J(i, t) .

With some calculation, the following can be shown. As
a note, this lemma provides an intermediate result whose
(t)
(t)
main purpose is to lay down the definition of j and 'i ,
which are then used in defining O(z, T ) (Eq. (21)) and rn
(Eq. (23)) and in Theorem A.2.

( Pk

where

for i = 1, . . . , m2 1 and
!! expectation
(t)
x Mi,j + Ui
h
i
.
(t)
T (2t) /pi
E Ui L(t) = Mi,
Mi,j

j=1

2
that the sequence {Mi, (j) + L (j) }m
j=1 are monotonically
non-decreasing. Define the auxiliary quantity
Qk 1
m2
X
(1
k)
j=1 k
(t) def.
,
(20)
Pk
i =
j=1 q (j)
k=1

(i)

M
M

(i+1),j

(i),j

i

)

def.

for i = 1, . . . , m1 1, and µm1 = 0 . Then, the conditional
expectation
h
i
(t+1)
(t)
(t) (2t)
E Lj
U(t) = U (1) M (1),j
.
j T
In particular, we denote (1) by Ijt or I(j, t) .

(ii) Given 1  i  m1 and 1  t  N , let the sorted
m2
2
index of {Mi,j + Lj }m
j=1 be permutation { (j)}j=1 such

We note that the calculation of Eq. (19) and Eq. (20) needs
O(m1 log m1 ) and O(m2 log m2 ) time respectively. By
a few additional calculations, we introduce the notation
O(·, ·):
O(z2t , T (2t) )
h
def.
= E hq, L(t) i
=

m2 ⇣
X

hq, L(t+1) i U(t) , L(t)
(t)

(t)

MIjt ,j + Lj

UI t +
j

j=1

O(z2t 1 , T (2t 1) )
h
def.
= E hp, U(t) i hp, U(t
=

m1 ⇣
X
i=1

(t)

Mi,Jit + LJ t

1)

i

⇥

(t) (2t)
j T

i U(t

(t 1)

Ui

Note that O(zn , T n ) = E V (zn+1 )

i

+

1)

⌘

qj

, L(t)

i

(t) (2t 1)
i T

V (zn )|z

⇤
n

⌘

pi
(21)

.

Recovery of Approximate Primal Solution. An approximate (m1 + m2 )-sparse primal solution4 can be recovered
from zn at n = 2t by
Z⇡

1
sparse(1 : m1 , J(1 : m1 , t), p)+
2
1
sparse(I(1 : m2 , t), 1 : m2 , q) 2 Rm1 ⇥m2 .
2

(22)

Concentration Bounds. We are interested in the concentration bound related to V (zn ) because it replaces the true
4

The notation of sparse(·, ·, ·) function is introduced under
the syntax of MATLAB: http://www.mathworks.com/
help/matlab/ref/sparse.html

A Simulated Annealing Based Inexact Oracle for Wasserstein Loss Minimization

Wasserstein loss in WLMs. Given U(0) (i.e., z1 is implied),
for n = 1, . . . , 2N , we let
n
X1

rn = V (zn )

s=1

O(zs , T (s) ) .

(23)

This is crucial for one who wants to know whether the cooling schedule is too fast to secure the suboptimality within
a finite budget of iterations. The following Theorem A.2
gives a possible route to approximately realize this goal. It
bounds the difference between
V (zn )

V (z1 ) and

n
X1
s=1

⇥
E V (zs+1 )

⇤
V (zs )|zs ,

the second of which is a quantitative term represents
(s)
ing⇥ sum of a sequence.
⇤ We see that O(z , T (s)) =
s+1
s
s
E V (z ) V (z )|z
= 0 if and only if T
=
def.

T (zs ) =
8
m
P2 h
1
(t)
>
>
qj MIjt ,j + Lj
<
(t)
h
, qi j=1
m
P1 h
1
>
(t)
>
pi Mi,Jit + LJ t
:
i
h (t) , pi i=1

(t)

UI t
j

i

(t 1)

Ui

if s = 2t
i

if s = 2t 1

(24)
In the practice of Gibbs-OT, choosing the proper cooling
schedule for a specific WLM needs trial-and-error. Here
we present a heuristics that the temperature T (s) is often
chosen and adapted around ⌘T (z s ), where ⌘ 2 [0.1, 0.9].
We have two concerns regarding the choice of temperature
T : First, in a WLM, the cost V (z) is to be gradually minimized, hence a temperature T smaller than T (zs ) at every iteration ensures that the cost is actually decreased by
expectation, i.e., E[V (zn ) V (z1 )] < 0; second, if T is
too small, it takes many iterations to reach a highly accurate equilibrium, which might not be necessary for a single
outer level step of parameter update.
Theorem A.2 (Concentration bounds for finite time Gibbs-OT). First, rn (by definition) is a martingale subject to
the filtration of z1 , . . . , zn . Second, given a " 2 (0, 1), for
n = 1, . . . , 2N 1 if we choose the temperature sched)
n
(n)
ule T (1) , . . . , T (2N
 an , or
⇣ such that (i)⌘C · T
2N max{m1 ,m2 }
(n)
n
(ii) 9 > 0, log
·
T
+
D
 an ,
"
where {an
0} is a pre-determined array. Here for
t = 1, . . . , N,
C 2t
C
D2t

1

def.

2t

def.

1

def.

=
=
=

h

(t)

, pi ,

where Mi,· and M·,j represents the i-th rows and jth columns of matrix M respectively, (t) and (t) are
def.
defined
in Lemma A.1, and regret function R(x; w) =
Pm
m
min1im xi for any w 2 m and x 2 R .
i=1 wi xi
Then for any K > 0, we have

Pr r2N < r1 K  exp
or
Pr r

2N

1

"

> r + K  exp

K2

2

"

P2N

1

i=1

a2n

#

K2

2

P2N

1

i=1

a2n

(25)

,

#

+ " . (26)

Remark 5. The bound obtained is a quantitative Hoeffding
bound, not a bound that guarantees contraction around the
true solution of dual OT. Nevertheless, we argue that this
bound is still useful in investigating the proposed Gibbs
sampler when the temperature is not annealed to zero. Particularly, the bound is for cooling schedules in general, i.e.,
it is more applicable than a bound for a specific schedule.
There has long been a gap between the practice and theory
of SA despite of its wide usage. Our result likewise falls
short of firm theoretical guarantee from the optimization
perspective, as with the usual application of SA.

B. Proof of Lemmas and Theorem
The minimum of n independent exponential random variables with different parameters has computatable formula
for its expectation. The result immediately lays out the
proof of Lemma A.1.
Lemma B.1. Suppose we have n independent exponential random variables ei whose c.d.f. is by fi (x) =
min{exp(!i (x zi )), 1}. Without lose of generality, we
assume
z2
... izn , then let zn+1 = 1, hi =
h P z1
i
exp
zi )  1 (with hn = 0, zn+1 hn =
j=1 !j (zi+1
0), we have

E [max{e1 , . . . , en }] = z1

n
X
(1
i=1

hi )
Pi

Qi

j=1

1
j=1

!j

hi

.

(t)

h
, qi ,
m
1
⇣
⌘
X
T
pi R Mi,·
+ L(t) ; q ,
i=1

D2t

def.

=

m2
X
i=1

⇣
qj R M·,j

U(t) ; p

⌘

,

Proof.
The c.d.f.
of max{e1 , . . . , en } is F (x) =
Qn
f
(x)
which
is
piece-wise smooth with interval
i=1 i

A Simulated Annealing Based Inexact Oracle for Wasserstein Loss Minimization

(zi+1 , zi ), we want to calculate
Z
=

1

i=1

=

n Z
X
i=1

=

=

xdF (x) + 0
zi+1
zi
zi+1

zi+1

n n
X

2

xd exp 4
2
4

i
X
j=1

zi

=

!

1

j=1

!j
!

!j

j=1

n
X
(1

rn

zj ) 5

i
X

!j (x

j=1

2

exp 4
2

exp 4

i
X

i
X

3

C 2t

zj )5 dx

!j (zi

!j (zi+1

j=1

#i 1
Y

3

zj ) 5

3

zj ) 5

o

1 def.

Qi

1
j=1

(t)

=h

(t)

, qi.

(27)

where for t = 1, . . . , N

hi

D2t

j=1

1 def.

=

def.

D2t =

m1
X

i=1
m2
X

⇣
⌘
T
pi R Mi,·
+ L(t) ; q

⇣
qj R M·,j

i=1

hi

def.

, pi and C 2t = h

Second, we also bound on the right hand side. That said,
for any 1 > " > 0, we have
⇣
Pr 9n 2 {1, . . . , 2N }, s.t. rn+1 rn
✓
◆
⌘
2N max{m1 , m2 }
log
·T (n) +Dn z1 , . . . , zn  ",
"
(28)

j=1

hi )
Pi

rn+1  C n · T (n) ,

where for t = 1, . . . , N

j=1

1 hi
(zi zi+1 hi ) Pi
j=1 !j
i=1
2
3
n
iY
1
i
X
Y
4 zi
hi zi+1
hi 5
i=1

=

Pi

"

2

!j 5 x exp 4
1

3

!j (x

j=1

j=1

zi+1

=

i
X

3

Pi

i=1

n
X

Lemma
B.3. Note ⇤ that
Eq.
(21)
implies
⇥
E rn+1 rn |z1 , . . . , zn = 0 for t = 1, . . . , 2N .
Therefore, {rn } is a (discrete time) martingale subject to
the filtration of {zn }. (Recall the notation by Eq. (14).)
Moreover, we have the following two bounds. First, we can
1
establish the left hand side bound for {rn+1 rn }2N
n=1 :

xdF (x) .

zi

n Z zi
X
i=1

1

xdF (x)

1

n Z
X

R1

(29)

⌘
U(t) ; p ,

(30)

where Mi,· and M·,j represents the i-th rows and j-th
columns of matrix M respectively.

j=1 !j
i=1
Qi 1
n
X
(1 hi ) j=1 hi
z1
.
Pi
j=1 !j
i=1

Proof. On one hand, because for each i 2 {1, . . . , m1 },
(t)
(t)
Ui |L(t) is lower bounded by Mi,J(i,t) + LJ(i,t)
(t)

(Lemma B.2), and for each j 2 {1, . . . , m2 }, Lj |U(t

1)

(t 1)
UI(j,t)

Therefore Lemma A.1 is proved up to trivial calculation
using the above Lemma B.1. In order to further prove
Lemma B.3, we also have (by definition of F (x)).
Lemma B.2. Subject to the setup of Lemma B.1, we also
have
max{e1 , . . . , en }  z1 ,
and

(

F (x)  min exp

"

n
X

!i (x

i=1

Pn
! i zi
where z ⇤ = Pi=1
.
n
i=1 !i

#

)

z ⇤ ) , 1 , 1 < x < 1,

Therefore, based on the observation of Lemma B.2, the tail
probability P r(max{e1 , . . . , en } < x) is upper bounded
by the probability of an exponential random variable,
which lead us to the proof of Lemma B.3.

is upper bounded by
MI(j,t),j (Lemma B.2),
n+1
we easily (by definition) have r
|z1 , . . . , zn is lower
n
n
(n)
bounded by r
C ·T .
On the other hand, we have if rn+1 rn
log(1/"0 ) ·
T (n) + Dn |z1 , . . . , zn for some "0 > 0, then at least one
(t)
(t)
of Ui (or Lj ) violates the bound log(1/"0 ) · T (n) +
T
R(Mi,·
+L(t) ; q) (or log(1/"0 )·T (n) +R(M·,j U(t) ; p)),
whose probability using Lemma B.2 is shown to be less
than "0 . Therefore, we have for each n
P r(rn+1

rn

log(1/"0 ) · T (n) + Dn |z1 , . . . , zn )
 max{m1 , m2 }"0 ,

(31)

and
P r(9n, rn+1

rn

log(1/"0 ) · T (n) + Dn |z1 , . . . , zn )
 2N max{m1 , m2 }"0 ,

(32)

Let " = 2N max{m1 , m2 }"0 , which concludes our result.

A Simulated Annealing Based Inexact Oracle for Wasserstein Loss Minimization

Given Lemma B.3, we can prove Theorem A.2 by applying the classical Azuma’s inequality for the left-hand side
bound, and applying one of its extensions (Proposition 34
in (Tao and Vu, 2015)) for the right-hand side bound. Remark that Theorem A.2 is about a single OT. For multiple
different OTs, which share the same temperature schedule, one can have asymptotic bounds using the Law of
Large Numbers due to the fact that their GibbsPsamplers
S
are independent with each other. Let Rn = S1 k=1 rkn ,
where rkn is defined by Eq. (23) for sample k. Since for
any " > 0, one has P ( Rn+1 Rn > ") ! 0 , as
S ! 1, one can have the asymptotic concentration bound
for R2N that for any "1 , "2 >⇣ 0 , there
⌘ exists S such that
1
P ( R2N R1 > "1 )  exp
2N "2 .
Tao, Terence and Vu, Van. Random matrices: Universality of
local spectral statistics of non-Hermitian matrices. The Annals of
Probability, 43(2):782-874, 2015.

