Supplemental Materials for:
Estimating individual treatment effect: generalization bounds and algorithms

Uri Shalit * 1 Fredrik D. Johansson * 2 David Sontag 2 3

A. Proofs
A.1. Definitions, assumptions, and auxiliary lemmas
We first define the necessary distributions and prove some
simple results about them. We assume a joint distribution function p(x, t, Y0 , Y1 ), such that (Y1 , Y0 ) ⊥
⊥ t|x, and
0 < p(t = 1|x) < 1 for all x. Recall that we assume Consistency, that is we assume that we observe y = Y1 |(t = 1)
and y = Y0 |(t = 0).
Definition A1. The treatment effect for unit x is:
τ (x) := E [Y1 − Y0 |x] .
We first show that under consistency and strong ignorability, the ITE function τ (x) is identifiable:

Assumption A1. The representation function Φ is one-toone. Without loss of generality we will assume that R is
the image of X under Φ, and define Ψ : R → X to be the
inverse of Φ, such that Ψ(Φ(x)) = x for all x ∈ X .
Definition A3. For a representation function Φ : X → R,
and for a distribution p defined over X , let pΦ be the distribution induced by Φ over R. Define pt=1
Φ (r) := pΦ (r|t =
(r)
:=
p
(r|t
=
0),
to
be
the
treatment
and control
1), pt=0
Φ
Φ
distributions induced over R.
For a one-to-one Φ, the distribution pΦ over R × {0, 1} can
be obtained by the standard change of variables formula,
using the determinant of the Jacobian of Ψ(r). See (BenIsrael, 1999) for the case of a mapping Φ between spaces
of different dimensions.
Lemma A2. For all r ∈ R, t ∈ {0, 1}:

Lemma A1. We have:

pΦ (t|r) = p(t|Ψ(r))
p(Yt |r) = p(Yt |Ψ(r)).

E [Y1 − Y0 |x] =
E [Y1 |x] − E [Y0 |x] =

(1)

E [Y1 |x, t = 1] − E [Y0 |x, t = 0] =

(2)

E [y|x, t = 1] − E [y|x, t = 0] .
Equality (1) is because we assume that Yt and t are independent conditioned on x. Equality (2) follows from the
consistency assumption. Finally, the last equation is composed entirely of observable quantities and can be estimated from data since we assume 0 < p(t = 1|x) < 1
for all x.
Definition A2. Let pt=1 (x) := p(x|t = 1), and
pt=0 (x) := p(x|t = 0) denote respectively the treatment
and control distributions.
Let Φ : X → R be a representation function. We will
assume that Φ is differentiable.
*

Equal contribution 1 CIMS, New York University, New
York, NY 10003 2 IMES, MIT, Cambridge, MA 02142
3
CSAIL, MIT, Cambridge, MA 02139.
Correspondence
to: Uri Shalit <shalit@cs.nyu.edu>, Fredrik D. Johansson
<fredrikj@mit.edu>.
Proceedings of the 34 th International Conference on Machine
Learning, Sydney, Australia, PMLR 70, 2017. Copyright 2017
by the author(s).

Proof. Let JΨ (r) be the absolute of the determinant of the
Jacobian of Ψ(r).
pΦ (t|r) =

pΦ (t, r) (a) p(t, Ψ(r))JΨ (r)
=
=
pΦ (r)
p(Ψ(r))JΨ (r)

p(t, Ψ(r))
= p(t|Ψ(r)),
p(Ψ(r))
where equality (a) is by the change of variable formula.
The proof is identical for p(Yt |r).
Let L : Y × Y → R+ be a loss function, e.g. the absolute
loss or squared loss.
Definition A4. Let Φ : X → R be a representation function. Let h : R×{0, 1} → Y be an hypothesis defined over
the representation space R. The expected loss for the unit
and treatment pair (x, t) is:
Z
`h,Φ (x, t) =
L(Yt , h(Φ(x), t))p(Yt |x)dYt
Y

Definition A5. The expected factual loss and counterfactual losses of h and Φ are, respectively:
Z
F (h, Φ) =
`h,Φ (x, t) p(x, t) dxdt
X ×{0,1}

Estimating individual treatment effect: generalization bounds and algorithms

Notation:
p(x, t): distribution on X × {0, 1}
u = p(t = 1): the marginal probability of treatment.
pt=1 (x) = p(x|t = 1): treated distribution. pt=0 (x) = p(x|t = 0): control distribution.
Φ: representation function mapping from X to R.
Ψ: the inverse function of Φ, mapping from R to X .
pΦ (r, t): the distribution induced by Φ on R × {0, 1}.
t=0
pt=1
Φ (r), pΦ (r): treated and control distributions induced by Φ on R.
L(·, ·): loss function, from Y × Y to R+ .
`h,Φ (x, t): the expected loss of h(Φ(x), t) for the unit x and treatment t.
F (h, Φ), CF (h, Φ): expected factual and counterfactual loss of h(Φ(x), t).
τ (x) := E [Y1 − Y0 |x], the expected treatment effect for unit x.
PEHE (f ): expected error in estimating the individual treatment effect of a function f (x, t).
IPMG (p, q): the integral probability metric distance induced by function family G between distributions p and q.
Z
CF (h, Φ) =

`h,Φ (x, t) p(x, 1
X ×{0,1}

− t) dxdt.

When it is clear from the context, we will sometimes use
F (f ) and CF (f ) for the expected factual and counterfactual losses of an arbitrary function f : X × {0, 1} → Y.
Definition A6. The expected treated and control losses
are:
Z
t=1
(h,
Φ)
=
`h,Φ (x, 1) pt=1 (x) dx
F
X

t=0
F (h, Φ) =

Z

`h,Φ (x, 0) pt=0 (x) dx

IPMG (·, ·) defines a pseudo-metric on the space of probability functions over S, and for sufficiently large function
families, IPMG (·, ·) is a proper metric (Müller, 1997). Examples of sufficiently large functions families includes the
set of bounded continuous functions, the set of 1-Lipschitz
functions, and the set of unit norm functions in a universal Reproducing Norm Hilbert Space. The latter two give
rise to the Wasserstein and Maximum Mean Discrepancy
metrics, respectively (Gretton et al., 2012; Sriperumbudur
et al., 2012). We note that for function families G such as
the three mentioned above, for which g ∈ G =⇒ −g ∈
G, the absolute value can be omitted from definition A7.

X

t=1
CF (h, Φ) =

Z

`h,Φ (x, 1) pt=0 (x) dx

X

t=0
CF (h, Φ) =

Z

`h,Φ (x, 0) pt=1 (x) dx.

X

The four losses above are simply the loss conditioned on
either the control or treated set. Let u := p(t = 1) be the
proportion of treated in the population. We then have the
immediate result:
Lemma A3.

A.2. General IPM bound
We now state and prove the most important technical
lemma of this section.
Lemma A4 (Lemma 1, main text). Let Φ : X → R be an
t=0
invertible representation with Ψ its inverse. Let pt=1
Φ , pΦ
be defined as in Definition A3. Let u = p(t = 1). Let
G be a family of functions g : R → R, and denote by
IPMG (·, ·) the integral probability metric induced by G.
Let h : R×{0, 1} → Y be an hypothesis. Assume there exists a constant BΦ > 0, such that for t = 0, 1, the function
gΦ,h (r, t) := B1Φ · `h,Φ (Ψ(r), t) ∈ G. Then we have:

t=0
F (h, Φ) = u · t=1
F (h, Φ) + (1 − u) · F (h, Φ)

CF (h, Φ) ≤
t=0
(1 − u)t=1
F (h, Φ) + uF (h, Φ)+

t=0
BΦ · IPMG pt=1
.
Φ , pΦ

t=0
CF (h, Φ) = (1 − u) · t=1
CF (h, Φ) + u · CF (h, Φ).

The proof is immediate, noting that p(x, t) = u · pt=1 (x) +
(1 − u) · (¸x), and from the Definitions A4 and A6 of the
losses.
Definition A7. Let G be a function family consisting of
functions g : S → R. For a pair of distributions p1 , p2
over S, define the Integral Probability Metric:
Z




IPMG (p1 , p2 ) = sup  g(s) (p1 (s) − p2 (s)) ds
g∈G

S

(3)

Proof.


t=0
CF (h, Φ) − (1 − u) · t=1
F (h, Φ) + u · F (h, Φ) =


t=0
(1 − u) · t=1
CF (h, Φ) + u · CF (h, Φ) −


t=0
(1 − u) · t=1
F (h, Φ) + u · F (h, Φ) =


t=1
(1 − u) · t=1
CF (h, Φ) − F (h, Φ) +


t=0
u · t=0
(4)
CF (h, Φ) − F (h, Φ) =

Estimating individual treatment effect: generalization bounds and algorithms

Z


(1 − u) `h,Φ (x, 1) pt=0 (x) − pt=1 (x) dx+
X
Z

u `h,Φ (x, 0) pt=1 (x) − pt=0 (x) dx =
(5)
X
Z

t=1
(1 − u) `h,Φ (Ψ(r), 1) pt=0
Φ (r) − pΦ (r) dr+
R
Z

t=0
u `h,Φ (Ψ(r), 0) pt=1
Φ (r) − pΦ (r) dr =
R
Z

1
t=1
`h,Φ (Ψ(r), 1) pt=0
BΦ · (1 − u)
Φ (r) − pΦ (r) dr+
R BΦ
Z

1
t=0
BΦ · u
`h,Φ (Ψ(r), 0) pt=1
Φ (r) − pΦ (r) dr ≤
RBΦ
(6)

Z



t=1

BΦ · (1 − u) sup  g(r) pt=0
Φ (r) − pΦ (r) dr  +
g∈G
R
Z


 
t=0
=
(7)
BΦ · u sup  g(r) pt=1
(r)
−
p
(r)
dr
Φ
Φ

g∈G

Let f : X × {0, 1} → Y by an hypothesis, such that
f (x, t) = h(Φ(x), t) for a representation Φ and hypothesis
h defined over the output of Φ.
Definition A9. The treatment effect estimate for unit x is:
τ̂f (x) = f (x, 1) − f (x, 0).
Definition A10. The expected Precision in Estimation of
Heterogeneous Effect (PEHE) loss of g is:
Z

2

(τ̂f (x) − τ (x)) p(x) dx.

PEHE (f ) =
X

Definition A11. The expected variance of Yt with respect
to a distribution p(x, t):

R

t=1
BΦ · IPMG (pt=0
Φ , pΦ ).

(8)

Equality (4) is by Definition A6 of the treated and control
loss, equality (5) is by the change of variables formula and
Definition A3 of pt=1
and pt=0
Φ
Φ , inequality (6) is by the
1
premise that BΦ · `h,Φ (Ψ(r), t) ∈ G for t = 0, 1, and (7) is
by Definition A7 of an IPM.

σY2 t (p(x, t)) =

Z

2

(Yt − mt (x)) p(Yt |x)p(x, t) dYt dx.
X ×Y

We define:
σY2 t = min{σY2 t (p(x, t)), σY2 t (p(x, 1 − t))},

The essential point in the proof of Lemma A4 is inequality 6. Note that on the l.h.s. of the inequality, we need to
and
evaluate the expectations of `h,Φ (Ψ(r), 0) over pt=1
Φ
.
Both
of
these
expectations
are
in
`h,Φ (Ψ(r), 1) over pt=0
Φ
general unavailable, since they require us to evaluate treatment outcomes on the control, and control outcomes on
the treated. We therefore upper bound these unknowable
quantities by taking a supremum over a function family
which includes `h,Φ (Ψ(r), 0) and `h,Φ (Ψ(r), 1). The upper bound ignores most of the details of the outcome, and
amounts to measuring a distance between two distributions
we have samples from: the control and treated distribution.
Note that for a randomized trial (i.e. when t ⊥
⊥ x) with we
t=0
have that IPM(pt=1
,
p
)
=
0.
Indeed,
it
is
straightforΦ
Φ
ward to show that in that case we actually have an equality:
t=0
CF (h, Φ) = (1 − u) · t=1
F (h, Φ) + u · F (h, Φ).
The crucial condition in Lemma A4 is that the function
gΦ,h (r) := B1Φ `h,Φ (Ψ(r), t) is in G. In subsections A.3
and A.4 below we look into two specific function families
G, and evaluate what does this inclusion condition entail,
and in particular we will derive specific bounds for BΦ .
Definition A8. For t = 0, 1 define:

σY2 = min{σY2 0 , σY2 1 }.
If Yt are deterministic functions of x, then σY2 = 0.
We now show that PEHE (f ) is upper bounded by 2F +
2CF − 2σY2 where F and CF are w.r.t. to the squared
loss. An analogous result can be obtained for the absolute
loss, using mean absolute deviation.
Lemma A5. For any function f : X × {0, 1} → Y, and
distribution p(x, t) over X × {0, 1}:
Z

2

(f (x, t) − mt (x)) p(x, t) dxdt =
X

F (f ) − σY2 t (p(x, t)),
Z

2

(f (x, t) − mt (x)) p(x, 1 − t) dxdt =
X

CF (f ) − σY2 t (p(x, 1 − t)),
where F (f ) and CF (f ) are w.r.t. to the squared loss.

mt (x) := E [Yt |x] .
Obviously for the treatment effect τ (x) we have τ (x) =
m1 (x) − m0 (x).

Proof. For simplicity we will prove for p(x, t) and F (f ).

Estimating individual treatment effect: generalization bounds and algorithms

The proof for p(x, 1 − t) and CF is identical.

PEHE (f ) = PEHE (h, Φ) for f (x, t) = h(Φ(x), t).
PEHE (f ) =
Z
2
(f (x, 1) − f (x, 0)) − (m1 (x) − m0 (x)) p(x) dx =
ZX
2
(f (x, 1) − m1 (x)) + (m0 (x) − f (x, 0)) p(x) dx ≤

F (f ) =
Z
2
(f (x, t) − Yt ) p(Yt |x)p(x, t) dYt dxdt =
X ×{0,1}×Y
Z
X
2
(11)
(f (x, t) − mt (x)) p(Yt |x)p(x, t) dYt dxdt+
Z 
X ×{0,1}×Y

Z
2
2
2
(f (x, 1) − m1 (x)) + (m0 (x) − f (x, 0)) p(x) dx =
2
(mt (x) − Yt ) p(Yt |x)p(x, t) dYt dxdt+
(9)
X
X ×{0,1}×Y
(12)
Z
Z
2
(f (x, t) − mt (x)) (mt (x) − Yt ) p(Yt |x)p(x, t) dYt dxdt = 2
(f (x, 1) − m1 (x)) p(x, t = 1) dx+
X ×{0,1}×Y
X
Z
(10)
2
Z
2
(m0 (x) − f (x, 0)) p(x, t = 0) dx+
2
X
(f (x, t) − mt (x)) p(x, t) dxdt+
Z
X ×{0,1}
2
2
(f (x, 1) − m1 (x)) p(x, t = 0) dx+
σY2 0 (p(x, t)) + σY2 1 (p(x, t)) + 0,
X
Z
2
2
(m0 (x) − f (x, 0)) p(x, t = 1) dx =
Z X
where the equality (10) is by the Definition A11 of σY2 t (p),
2
2
(f (x, t) − mt (x)) p(x, t) dxdt+
and because
R the integral in (9) evaluates to zero, since
X
Z
mt (x) = X Yt p(Yt |x) dx.
2
2
(f (x, t) − mt (x)) p(x, 1 − t) dxdt ≤
(13)
X

2(F − σY2 ) + 2(CF − σY2 ).
Theorem 1. Let Φ : X → R be a one-to-one representat=0
be defined as
tion function, with inverse Ψ. Let pt=1
Φ , pΦ
in Definition A3. Let u = p(t = 1). Let G be a family of
functions g : R → R, and denote by IPMG (·, ·) the integral
probability metric induced by G. Let h : R × {0, 1} → Y
be an hypothesis. Let the loss L(y1 , y2 ) = (y1 − y2 )2 . Assume there exists a constant BΦ > 0, such that for t ∈
{0, 1}, the functions gΦ,h (r, t) := B1Φ · `h,Φ (Ψ(r), t) ∈ G.
We then have:

where (11) is because (x + y)2 ≤ 2(x2 + y 2 ), (12) is because p(x) = p(x, t = 0) + p(x, t = 1) and (13) is by
Lemma A5 and Definition A5 of the losses F , CF and
Definition A11 of σY2 . Having established the first inequality in the Theorem statement, we now show the second. We
have by Lemma A4 that:
CF (h, Φ) ≤

t=0
t=1 t=0
(1 − u)t=1
.
F (h, Φ) + uF (h, Φ) + BΦ · IPMG pΦ , pΦ
We further have by Lemma A3 that:
t=0
F (h, Φ) = ut=1
F (h, Φ) + (1 − u)F (h, Φ).

PEHE (h, Φ) ≤

2 CF (h, Φ) + F (h, Φ) − 2σY2 ≤


t=1
t=1 t=0
2 t=0
−2σY2 ,
F (h, Φ)+F (h, Φ)+BΦ IPMG pΦ , pΦ

Therefore
CF (h, Φ) + F (h, Φ) ≤

t=0
t=1 t=0
t=1
.
F (h, Φ) + F (h, Φ) + BΦ IPMG pΦ , pΦ

where F and CF are with respect to the squared loss.

Proof. We will prove the first inequality, PEHE (f ) ≤
2CF (h, Φ) + 2F (h, Φ) − 2σY2 . The second inequality
is then immediate by Lemma A4. Recall that we denote

The upper bound is in terms of the standard generalization error on the treated and control distributions separately.
Note that in some cases we might have very different sample sizes for treated and control, and that will show up in
the finite sample bounds of these generalization errors.
We also note that the upper bound can be easily adapted to
the case of the absolute loss PEHE |τ̂ (x) − τ (x)|. In that

Estimating individual treatment effect: generalization bounds and algorithms

case the upper bound in the Theorem will have a factor 1
instead of the 2 stated above, and the standard deviation σY2
replaced by mean absolute deviation. The proof is straightforward where one simply applies the triangle inequality in
inequality (11).
We will now give specific upper bounds for the constant
BΦ in Theorem 1, using two function families G in the
IPM: the family of 1-Lipschitz functions, and the family of
1-norm reproducing kernel Hilbert space functions. Each
one will have different assumptions about the distribution
p(x, t, Y0 , Y1 ) and about the representation Φ and hypothesis h.
A.3. The family of 1-Lipschitz functions
For S ⊂ Rd , a function f : S → R has Lipschitz constant
K if for all x, y ∈ S, |f (x) − f (y)| ≤ Kkx − yk. If f is
differentiable, then a sufficient condition for K-Lipschitz
constant is if k ∂f
∂s k ≤ K for all s ∈ S.
For simplicity’s sake we assume throughout this subsection
that the true labeling functions the densities p(Yt |x) and the
loss L are differentiable. However, this assumption could
be relaxed to a mere Lipschitzness assumption.
Assumption A2. There exists a constant K > 0 such that
t |x)
for all x ∈ X , t ∈ {0, 1}, k p(Y∂x
k ≤ K.
Assumption A2 entails that each of the potential outcomes
change smoothly as a function of the covariates (context)
x.
Assumption A3. The loss function L is differentiable,

 and
 dL(y1 ,y2 ) 
there exists a constant KL > 0 such that  dyi  ≤ KL
for i = 1, 2. Additionally,R there exists a constant M such
that for all y2 ∈ Y, M ≥ Y L(y1 , y2 ) dy1 .
Assuming Y is compact, loss functions which obey Assumption A3 include the log-loss, hinge-loss, absolute loss,
and the squared loss.
When we let G in Definition A7 be the family of 1Lipschitz functions, we obtain the so-called 1-Wasserstein
distance between distributions, which we denote Wass(·, ·).
It is well known that Wass(·, ·) is indeed a metric between
distributions (Villani, 2008).
Definition A12. Let ∂Φ(x)
∂x be the Jacobian matrix of Φ at
point x, i.e. the matrix of the partial derivatives of Φ. Let
σmax (A) and σmin (A) denote respectively the largest and
smallest singular
A.
 values
 of a matrix

 Define ρ(Φ) =
supx∈X σmax

∂Φ(x)
∂x

/σmin

∂Φ(x)
∂x

.

It is an immediate result that ρ(Φ) ≥ 1.
Definition A13. We will call a representation function

Φ :
∂Φ(x)
X → R Jacobian-normalized if supx∈X σmax
=
∂x
1.

Note that any non-constant representation function Φ can
be Jacobian-normalized by a simple scalar multiplication.
Lemma A6. Assume that Φ is a Jacobian-normalized representation, and let Ψ be its inverse. For t = 0, 1, the Lipschitz constant of p(Yt |Ψ(r)) is bounded by ρ(Φ)K, where
K is from Assumption A2, and ρ(Φ) as in Definition A12.

Proof. Let Ψ : R → X be the inverse of Φ, which exists
by the assumption that Φ is one-to-one. Let ∂Φ(x)
∂x be the
Jacobian matrix of Φ evaluated at x, and similarly let ∂Ψ(r)
∂r
be the Jacobian matrix of Ψ evaluated at r. Note that ∂Ψ(r)
∂r ·
∂Φ(x)
∂x = I for r = Φ(x), since Ψ◦Φ is the identity function
on X . Therefore for any r ∈ R and x = Ψ(r):

σmax

∂Ψ(r)
∂r


=
σmin

1


∂Φ(x)
∂x

,

(14)

where σmax (A) and σmin (A) are respectively the largest
and smallest singular values of the matrix A, i.e. σmax (A)
is the spectral norm of A.
For x = Ψ(r) and t ∈ {0, 1}, we have by the chain rule:
∂p(Yt |Ψ(r))
∂p(Yt |Ψ(r)) ∂Ψ(r)
k=k
k≤
∂r
∂Ψ(r)
∂r
∂Ψ(r) ∂p(Yt |Ψ(r))
k
kk
k=
∂r
∂Ψ(r)
1
∂p(Yt |x)

k
k≤
∂Φ(x)
∂x
σ

k

min

σmin

(15)
(16)
(17)

∂x

K


∂Φ(x)
∂x

 ≤ ρ(Φ)K,

(18)

where inequality (15) is by the matrix norm inequality,
equality (16) is by (14), inequality (17) is by assumption
A2 on the norms of the gradient of p(Yt |x) w.r.t x , and
inequality (18) is by Definition A12 of ρ(Φ), the assumption that Φ is Jacobian-normalized, and noting that singular
values are necessarily non-negative.

Lemma A7. Under the conditions of Lemma A4, further
assume that for t = 0, 1, p(Yt |x) has gradients bounded
by K as in A2, that h has bounded gradient norm bK,
that the loss L has bounded gradient norm KL , and that
Φ is Jacobian-normalized. Then the Lipschitz constant of
`h,Φ (Ψ(r), t) is upper bounded by KL · K (M ρ(Φ) + b)
for t = 0, 1.

Estimating individual treatment effect: generalization bounds and algorithms

Proof. Using the chain rule, we have that:
Z
∂`h,Φ (Ψ(r), t)
∂
k
k=k
L(Yt , h(r, t))p(Yt |r)dYt k =
∂r
∂r Y
Z
∂
k
[L(Yt , h(r, t))p(Yt |r)] dYt k =
∂r
Y
Z
∂
∂
k p(Yt |r) L(Yt , h(r, t))+L(Yt , h(r, t)) p(Yt |r)dYt k ≤
∂r
∂r
Z Y
∂
p(Yt |r)k L(Yt , h(r, t))k dYt +
∂r
ZY
∂
L(Yt , h(r, t)) p(Yt |r) dYt ≤
(19)
∂r
Y
Z
∂L(Yt , h(r, t)) ∂h(r, t)
k dYt +
p(Yt |r)k
∂h(r, t)
∂r
ZY
∂
L(Yt , h(r, t)) p(Yt |r) dYt ≤
(20)
∂r
ZY
p(Yt |r)KL · b · K + M · ρ(Φ) · K,
(21)
Y

where inequality 19 is due to Assumption A3 and inequality 20 is due to Lemma A6.
Lemma A8. Let u = p(t = 1) be the marginal probability
of treatment, and assume 0 < u < 1. Let Φ : X → R be a
one-to-one, Jacobian-normalized representation function.
Let K be the Lipschitz constant of the functions p(Yt |x) on
X . Let KL be the Lipschitz constant of the loss function L,
and M be as in Assumption A3. Let h : R × {0, 1} → R
be an hypothesis with Lipschitz constant bK. Then:
CF (h, Φ) ≤
t=0
(1 − u)t=1
F (h, Φ) + uF (h, Φ)+
t=0
2 (M ρ(Φ) + b) · K · KL · Wass(pt=1
Φ , pΦ ).

(22)

Proof. We will apply Lemma A4 with G = {g :
R → R s.t. f is 1-Lipschitz}. By Lemma A7, we have
that for BΦ = (M ρ(Φ) + b) · K · KL , the function
1
BΦ `h,Φ (Ψ(r), t) ∈ G. Inequality (22) then holds as a special case of Lemma A4.
Theorem 2. Under the assumptions of Lemma A8, using
the squared loss for F , we have:

our control and measures an aspect of the complexity of
the true underlying functions we wish to approximate. The
terms KL and M depend on our choice of loss function and
the size of the space Y. The term b comes from our assumption that the hypothesis h has norm bK. Note that smaller
b, while reducing the bound, might force the factual loss
term F (h, Φ) to be larger since a small b implies a less
flexible h. Finally, consider the term ρ(Φ). The assumption that Φ is normalized is rather natural, as we do not
expect a certain scale from a representation. Furthermore,
below we show that in fact the Wasserstein distance is positively homogeneous with respect to the representation Φ.
Therefore, in Lemma A8, we can indeed assume that Φ is
normalized. The specific choice of Jacobian-normalized
scaling yields what is in our opinion a more interpretable
result in terms of the inverse condition number ρ(Φ). For
twice-differentiable Φ, ρ(Φ) is minimized if and only if Φ
is a linear orthogonal transformation (mat).
Lemma A9. The Wasserstein distance is positive homogeneous for scalar transformations of the underlying space.
Let p, q be probability density functions defined over X .
For α > 0 and the mapping Φ(x) = αx, let pα and qα be
the distributions on αX induced by Φ. Then:
Wass (pα , qα ) = αWass (p, q) .
Proof. Following (Villani, 2008; Kuang & Tabak, 2016),
we use another characterization of the Wasserstein distance. Let Mp,q be the set of mass preserving maps from
X to itself which map the distribution p to the distribution q. That is, Mp,q = {M : X → X s.t. q(M (S)) =
p(S) for all measurable bounded S ⊂ X }. We then have
that:
Z
Wass(p, q) = inf
kM (x) − xkp(x) dx. (23)
M ∈Mp,q

X

It is known that the infimum in (23) is actually achievable
(Villani, 2008, Theorem 5.2). Denote by M ∗ : X → X
the map achieving the infimum for Wass(p, q) . Define
0
Mα∗ : αX → αX , by Mα∗ (x0 ) = αM ∗ ( xα ), where
x0 = αx. Mα∗ maps pα to qα , and we have that kMα∗ (x0 ) −
x0 k = αkM ∗ (x)−xk. Therefore Mα∗ achieves the infimum
for the pair (pα , qα ), and we have that Wass (pα , qα ) =
αWass (p, q).

PEHE (h, Φ) ≤
t=1
2
2t=0
F (h, Φ) + 2F (h, Φ) − 4σY +

A.4. Functions in the unit ball of a RKHS

Proof. Plug in the upper bound of Lemma A8 into the upper bound of Theorem 1.

Let Hx , Hr be a reproducing kernel Hilbert space, with
corresponding kernels kx (·, ·), kr (·, ·). We have for all
x ∈ X that kx (·, x) is its Hilbert space mapping, and similarly kr (·, r) for all r ∈ R.

We examine the constant (M ρ(Φ) + b)·K ·KL in Theorem
A8. K, the Lipschitz constant of m0 and m1 , is not under

Recall that the major condition in Lemma A4 is that
1
BΦ `h,Φ (Ψ(r), t) ∈ G. The function space G we use here
is G = {g ∈ Hr s.t. kgkHr ≤ 1}.

t=0
2 (M ρ(Φ) + b) · K · KL · Wass(pt=1
Φ , pΦ ).

Estimating individual treatment effect: generalization bounds and algorithms

We will focus on the case where L is the squared loss, and
we will make the following two assumptions:

where
equality (24) is by Definition A14 of η, and because
R
(Y
− mt (x)) p(Yt |x) dYt = 0 by definition of mt (x).
t
Y

Y
Y
Assumption

 YA4. There exist f0 , f1 ∈ Hx such that
mt (x) = ft , kx (x, ·) Hx , i.e. the mean potential outcome functions m0 , m1 are in Hx . Further assume that
kftY kHx ≤ K.

Moving to R, recall that r = Φ(x), x = Ψ(r).
By linearity of the Hilbert space,

 ∗ Y we have
 that
mt (Ψ(r)) − h(r, t)
=
ΓΦ ft , kr (r, ·) Hr −




 h

ft , kr (r, ·) Hr = Γ∗Φ ftY − fth , kr (r, ·) Hr . By a well
known result (Steinwart & Christmann, 2008, Theorem
7.25), the product (Yt (Ψ(r))−h(r, t))·(Yt (Ψ(r))−h(r, t))
lies
product space Hr ⊗ Hr , and is equal
to

 ∗in Ythe tensor

(ΓΦ ft − fth ) ⊗ (Γ∗Φ ftY − fth ), kr (r, ·) ⊗ kr (r, ·) H ⊗H .
r
r
The norm of this function in Hr ⊗ Hr is kΓ∗Φ ftY − fth k2Hr .
This is the general Hilbert space version of the fact that for
a vector w ∈ Rd one has that kww> kF = kwk22 , where
k · kF is the matrix Frobenius norm, and k · k22 is the
square of the standard Euclidean norm. We therefore have
a similar result for ηY2 t , using Assumption A5: ηY2 t (x) =
ηY2 t (Ψ(r)) = hΓ∗Φ ftη ⊗ Γ∗Φ ftη , kr (r, ·) ⊗ kr (r, ·)iHr ⊗Hr .
The norm of this function in Hr ⊗ Hr is kΓ∗Φ ftη k2Hr .
Overall this leads us to conclude, using Equation (25) that
`h,Φ (Ψ(r), t) ∈ Hr ⊗ Hr . Now we have, using (25):

Definition
A14.
Define
ηYt (x)
:=
q
R
2
(Yt − mt (x)) p(Yt |x).
ηYt (x) is the standard
Y
deviation of Yt |x.
Assumption A5. There exists f0η , f1η ∈ Hx such that
ηYt (x) = hftη , kx (x, ·)iHx , i.e. the conditional standard
deviation functions of Yt |x are in Hx . Further assume that
kftη kHx ≤ M .
Assumption A6. Let Φ : X → Y be an invertible representation function, and let Ψ be its inverse. We assume
there
exists a boundedlinear operator
ΓΦ : Hr → Hx such


that ftY , kx (Ψ(r), ·) Hx = ftY , ΓΦ kr (r, ·) Hx . We further assume that the Hilbert-Schmidt norm (operator norm)
kΓΦ kHS of ΓΦ is bounded by KΦ .
The two assumptions above amount to assuming that Φ can
be represented as one-to-one linear map between the two
Hilbert spaces Hx and Hr .

k`h,Φ (Ψ(r), t)kHr ⊗Hr =

Under Assumptions A4 
and A6 about m0 , m1 , and Φ, we
have that mt (Ψ(r)) = Γ∗Φ ftY , kr (r, ·) Hr , where Γ∗Φ is
the adjoint operator of ΓΦ (Grunewalder et al., 2013).

kΓ∗Φ ftY − fth k2Hr + kΓ∗Φ ftη k2Hr ≤

(27)

2kΓ∗Φ ftY k2Hr + 2kfth k2Hr + kΓ∗Φ ftη k2Hr ≤

kΓ∗Φ k2HS 2kftY k2Hx + kftη k2Hx + 2kfth k2Hr

kΓΦ k2HS 2kftY k2Hx + kftη k2Hx + 2kfth k2Hr
2KΦ2 (K 2 + M 2 ) + 2b2 .

(28)

Lemma A10. Let h : R × {0, 1} → R be an hypothesis,
h
r such that h(r, t) =

andh assume that there exist ft ∈ H
ft , kr (r, ·) Hr , and such that kfth kHr ≤ b. Under Assumption A4 about m0 , m1 , we have that `h,Φ (Ψ(r), t) =
R
2
(Yt − h(r, t)) p(Yt |r)dYt is in the tensor Hilbert space
Y
Hr ⊗ Hr . Moreover, the norm of `h,Φ (Ψ(r), t) in Hr ⊗ Hr
is upper bounded by 4 KΦ2 K 2 + b2 .
R
2
Proof. We first decompose Y (Yt − h(r, t)) p(Yt |x)dYt
into a noise and mean fitting term, using r = Φ(x):
`h,Φ (Ψ(r), t) =
Z
2
(Yt − h(r, t)) p(Yt |r) dYt =
ZY
2
(Yt − mt (x) + mt (x) − h(Φ(x), t)) p(Yt |x) dYt =
ZY
2
(Yt − mt (x)) p(Yt |x) dYt +
Y
2

(mt (x) − h(Φ(x), t)) +
Z
2
(Yt − mt (x)) (mt (x) − h(Φ(x), t)) p(Yt |x)dYt =
Y

(24)
ηY2 t (x)

2

+ (mt (x) − h(Φ(x), t)) + 0,

(25)

k(Γ∗Φ ftY − fth ) ⊗ (Γ∗Φ ftY − fth ) + Γ∗Φ ftη ⊗ Γ∗Φ ftη kHr ⊗Hr ≤
(26)

=

(29)

≤

(30)

Inequality (26) is by the norms given above and the triangle
inequality. Inequality (27) is because for any Hilbert space
H, ka − bk2H ≤ 2kak2H + 2kbk2H . Inequality (28) is by the
definition of the operator norm. Equality (29) is because
the norm of the adjoint operator is equal to the norm of
the original operator, where we abused the notation k · kHS
to mean both the norm of operators from Hx to Hr and
vice-versa. Finally, inequality (30) is by Assumptions A4,
A5 and A6, and by the Lemma’s premise on the norm of
fTh .
Lemma A11. Let u = p(t = 1) be the marginal probability of treatment, and assume 0 < u < 1. Assume the
distribution of Yt conditioned on x follows Assumptions
A5 with constant M . Let Φ : X → R be a one-to-one
representation function which obeys Assumption A6 with
corresponding operator ΓΦ with operator norm KΦ . Let
the functions Y0 , Y1 obey Assumption A4, with bounded
Hilbert space norm K . Let h : R × {0, 1} → R be an
h
hypothesis,
assume

 and
 that there exist fht ∈ Hr such that
h
h(r, t) = ft , kr (r, ·) Hr , such that kft kHr ≤ b. Assume
that F and CF are defined with respect to L being the

Estimating individual treatment effect: generalization bounds and algorithms

squared loss. Then:
CF (h, Φ) ≤
t=0
(1 − u)t=1
F (h, Φ) + uF (h, Φ)+

t=0
2 KΦ2 (K 2 + M 2 ) + b2 · MMD(pt=1
Φ , pΦ ),

(31)
where CF and F use the squared loss.
Proof. We will apply Lemma A4 with G
=
f ∈ Hr ⊗ Hr s.t. kf kHr ⊗Hr ≤ 1.
By Lemma
A10,

we have that for BΦ = 2 KΦ2 (K 2 + M 2 ) + b2 and L
being the squared loss, B1Φ `h,Φ (Ψ(r), t) ∈ G. Inequality
(31) then holds as a special case of Lemma A4.
Theorem 3. Under the assumptions of Lemma A11, using
the squared loss for F , we have:

Algorithm 1 Computing the stochastic gradient of the
Wasserstein distance
1: Input: Factual (x1 , t1 , y1 ), . . . , (xn , tn , yn ), representation network ΦW with current weights by W
2: Randomly sample a mini-batch with m treated and m0
control units (xi1 , 0, yi1 ), . . . ,
(xim , 0, yim ), (xim+1 , 1, yim+1 ), . . . , (xi2m , 1, yi2m )
3: Calculate the m × m pairwise distance matrix between
all treatment and control pairs M (ΦW ):
Mkl (Φ) = kΦW (xik ) − ΦW (xim+l )k
4: Calculate the approximate optimal transport matrix T ∗
using Algorithm 3 of Cuturi & Doucet (2014), with
input M (ΦW )
5: Calculate the gradient:
g1 = ∇W hT ∗ , M (ΦW )i

as a recurrent neural network, where the states ut evolve
according to

PEHE (h, Φ) ≤
t=1
2
2t=0
F (h, Φ) + 2F (h, Φ) − 4σY +

t=0
4 KΦ2 (K 2 + M 2 ) + b2 · MMD(pt=1
Φ , pΦ ).

Proof. Plug in the upper bound of Lemma A11 into the
upper bound of Theorem 1.

>
ut+1 = nt ./(nc K(1./(u>
t K) )) .

Here, K is a kernel matrix corresponding to a metric such
as the euclidean distance, Kij = e−λkΦ(xi )−Φ(xj )k2 , and
nc , nt are the sizes of the control and treatment groups. In
this way, we can minimize our entire objective with most
of the frameworks commonly used for training neural networks, out of the box.

B. Algorithmic details
We give details about the algorithms used in our framework.

B.2. Minimizing the maximum mean discrepancy
The MMD of treatment populations in the representation
Φ, for a kernel k(·, ·) can be written as,

B.1. Minimizing the Wasserstein distance
In general, computing (and minimizing) the Wasserstein
distance involves solving a linear program, which may
be prohibitively expensive for many practical applications.
Cuturi (2013) showed that an approximation based on entropic regularization can be obtained through the SinkhornKnopp matrix scaling algorithm, at orders of magnitude
faster speed. Dubbed Sinkhorn distances, the approximation is computed using a fixed-point iteration involving repeated multiplication with a kernel matrix K. We can use
the algorithm of Cuturi (2013) in our framework. See Algorithm 1 for an overview of how to compute the gradient
g1 in Algorithm ??. When computing g1 , disregarding the
gradient ∇W T ∗ amounts to minimizing an upper bound on
the Sinkhorn transport. More advanced ideas for stochastic optimization of this distance have recently proposed by
Aude et al. (2016), and might be used in future work.
While our framework is agnostic to the parameterization of
Φ, our experiments focus on the case where Φ is a neural
network. For convenience of implementation, we may represent the fixed-point iterations of the Sinkhorn algorithm

0

m
MMDk ({ΦW (xij )}m
j=1 , {ΦW (xik )}k=m+1 ) = (32)
m
m
X
X
1
k(ΦW (xij ), ΦW (xik )) (33)
m(m − 1) j=1
k=1,k6=j

+

2
mm0

0
m m+m
X
X

k(ΦW (xij ), ΦW (xik )) (34)

j=1 k=m

m

X
1
+ 0
m (1 − m0 ) j=1

0

m
X

k(ΦW (xij ), ΦW (xik )) (35)

k=m,k6=j

The linear maximum-mean discrepancy can be written as a
distance between means. In the notation of Algorithm ??,


 X

m0
X
1 m

1

Φ
(x
)
−
MMD = 2 
Φ
(x
)
W ij
W ik 
m
0
m
 j=1

k=m+1

2

Let
m

1 X
1
ΦW (xij ) − 0
f (W) =
m j=1
m

0
m+m
X

k=m+1

ΦW (xik )

Estimating individual treatment effect: generalization bounds and algorithms
Table 1. Hyperparameters and ranges.

Parameter
Imbalance parameter, α
Num. representation layers
Num. hypothesis layers
Dim. representation layers
Dim. hypothesis layers
Batch size
Normalization
Weight decay (hypothesis)

Range
{10k/2 }6k=−10
{1, 2, 3}
{1, 2, 3}
{20, 50, 100, 200}
{20, 50, 100, 200}
{100, 200, 500, 700}
{projection, batch norm}
{10−4 , 10−3 , 10−2 }

Then the gradient of the MMD with respect to W is,
df (W) f (W)
g1 = 2
.
dW kf (W)k2

References
MathOverflow: functions with orthogonal Jacobian. https:
//mathoverflow.net/questions/228964/
functions-with-orthogonal-jacobian.
Accessed: 2016-05-05.
Aude, Genevay, Cuturi, Marco, Peyré, Gabriel, and Bach, Francis.
Stochastic optimization for large-scale optimal transport. arXiv
preprint arXiv:1605.08527, 2016.
Ben-Israel, Adi. The change-of-variables formula using matrix
volume. SIAM Journal on Matrix Analysis and Applications,
21(1):300–312, 1999.
Cuturi, Marco. Sinkhorn distances: Lightspeed computation of
optimal transport. In Advances in Neural Information Processing Systems, pp. 2292–2300, 2013.
Cuturi, Marco and Doucet, Arnaud. Fast computation of Wasserstein barycenters. In Proceedings of The 31st International
Conference on Machine Learning, pp. 685–693, 2014.

C. Experimental details

Gretton, Arthur, Borgwardt, Karsten M., Rasch, Malte J.,
Schölkopf, Bernhard, and Smola, Alexander. A kernel twosample test. J. Mach. Learn. Res., 13:723–773, March 2012.
ISSN 1532-4435.

Our implementations of CFR and TARNet are based on
Python and TensorFlow and are available at https://
github.com/clinicalml/cfrnet. Both models
were trained using stochastic gradient descent with Adam.

Grunewalder, Steffen, Arthur, Gretton, and Shawe-Taylor, John.
Smooth operators. In Proceedings of the 30th International
Conference on Machine Learning (ICML-13), pp. 1184–1192,
2013.

C.1. Hyperparameter selection

Kuang, Max and Tabak, Esteban. Preconditioning of optimal
transport. Preprint, 2016.

Standard methods for hyperparameter selection, such as
cross-validation, are not generally applicable for estimating the PEHE loss since only one potential outcome is
observed (unless the outcome is simulated). For realworld data, we may use the observed outcome yj(i)
of the nearest neighbor j(i) to i in the opposite treatment group, tj(i) = 1 − ti as surrogate for the counterfactual outcome. We use this to define a nearestneighbor approximation of the PEHE loss, PEHEnn (f ) =
2
Pn
1
.
i=1 (1 − 2ti )(yj(i) − yi ) − (f (xi , 1) − f (xi , 0))
n
On IHDP, we use the objective value on the validation set
for early stopping in CFR, and PEHEnn (f ) for hyperparameter selection. On the Jobs dataset, we use the policy risk
on the validation set.
See Table 1 for a description of hyperparameters and search
ranges.
C.2. Learned representations
Figure 1 show the representations learned by our CFR algorithm.
C.3. Absolute error for increasingly imbalanced data
Figure 2 shows the results of the same experiment as Figure
2 of the main paper, but in absolute terms.

Müller, Alfred. Integral probability metrics and their generating
classes of functions. Advances in Applied Probability, pp. 429–
443, 1997.
Sriperumbudur, Bharath K, Fukumizu, Kenji, Gretton, Arthur,
Schölkopf, Bernhard, Lanckriet, Gert RG, et al. On the empirical estimation of integral probability metrics. Electronic
Journal of Statistics, 6:1550–1599, 2012.
Steinwart, Ingo and Christmann, Andreas. Support vector machines. Springer Science & Business Media, 2008.
Villani, Cédric. Optimal transport: old and new, volume 338.
Springer Science & Business Media, 2008.

Estimating individual treatment effect: generalization bounds and algorithms

(a) Original data

(b) Linear MMD

(c) Wasserstein

Figure 1. t-SNE visualizations of the balanced representations of IHDP learned by our algorithms CFR, CFR MMD and CFR Wass. We
note that the nearest-neighbor like quality of the Wasserstein distance results in a strip-like representation, whereas the linear MMD
results in a ball-like shape in regions where overlap is small.

4.5

q = 0: 0

4.0

q = 0: 5

²PEHE

3.5

q = 1: 0

3.0
2.5
2.0
1.5
1.0
0

10 -5

10 -4

10 -3

10 -2

10 -1

10 0

10 1

10 2

Imbalance penalty; ®
Figure 2. Out-of-sample error in estimated ITE, as a function of
IPM regularization parameter for CFR Wass, on 500 realizations
of IHDP, with high (q = 1), medium and low (artificial) imbalance between control and treated.

