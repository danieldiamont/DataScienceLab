Supplementary Material for Magnetic Hamiltonian Monte Carlo

1

Section 3 and 4 Proofs

Here we provide proofs for results discussed in Section 3 of the main text regarding non-canonical dynamics.
Lemma 1. The map Œ¶A
œÑ,H (Œ∏, p) defined by integrating the non-canonical Hamiltonian system


d Œ∏(t)
= A‚àáŒ∏,p H(Œ∏(t), p(t))
dt p(t)

(1)

with initial conditions (Œ∏, p) for time œÑ , where A ‚àà M2n√ó2n is any invertible, antisymmetric matrix induces
a flow on the coordinates (Œ∏, p) that is still energy-conserving (‚àÇœÑ H(Œ¶A
œÑ,H (Œ∏, p)) = 0) and symplectic with
respect to A ([‚àáŒ∏,p Œ¶œÑ,H (Œ∏, p)]> A‚àí1 [‚àáŒ∏,p Œ¶œÑ,H (Œ∏, p)] = A‚àí1 ) which also implies volume-preservation of the
flow.
Proof. The proofs of both results simply uses the antisymmetry of A.
Energy-Conservation ‚Äì Simply, we have that:
‚àÇœÑ H(Œ¶œÑ,H (Œ∏, p)) = ‚àáŒ∏,p H(Œ¶œÑ,H (Œ∏, p))‚àÇœÑ Œ¶œÑ,H (Œ∏, p) =
>

‚àáŒ∏,p H(Œ¶œÑ,H (Œ∏, p)) A‚àáŒ∏,p H(Œ¶œÑ,H (Œ∏, p)) = 0

(2)
(3)

using the antisymmetry of A and symmetry of ‚àáŒ∏,p H(Œ¶œÑ,H (Œ∏, p))‚àáŒ∏,p H(Œ¶œÑ,H (Œ∏, p))> .
Symplecticness ‚Äì We must show that the Jacobian of the flow generated by the dynamics preserves the
non-canonical structure matrix A, which amounts to showing:
[‚àáŒ∏,p Œ¶œÑ,H (Œ∏, p)]> A‚àí1 [‚àáŒ∏,p Œ¶œÑ,H (Œ∏, p)] = A‚àí1
|
{z
}
|
{z
}
F (œÑ )>

(4)

F (œÑ )

where we define F (œÑ ) = ‚àáŒ∏,p Œ¶œÑ,H (Œ∏, p) as the time-evolving Jacobian of the flow. First, note that F (œÑ ) can
be equivalently described as the solution to the differential equation:
d
F (œÑ ) = A‚àáŒ∏,p ‚àáŒ∏,p H(Œ¶œÑ,H (Œ∏, p))F (œÑ )
dœÑ

(5)

with the initial condition F (0) = I2d (the Jacobian for the identity map at t = 0). Trivially, we have:
F (0)A‚àí1 F (0) = A‚àí1

(6)

Then note that:
d
(F (œÑ )> A‚àí1 F (œÑ )) =
dœÑ
F (œÑ )> A‚àí1 A‚àáŒ∏,p ‚àáŒ∏,p H(Œ¶œÑ,H (Œ∏, p))F (œÑ ) + F (œÑ )> ‚àáŒ∏,p ‚àáŒ∏,p H(Œ¶œÑ,H (Œ∏, p))A> A‚àí1 F (œÑ )
= F (œÑ )> ‚àáŒ∏,p ‚àáŒ∏,p H(Œ¶œÑ,H (Œ∏, p))F (œÑ ) ‚àí F (œÑ )> ‚àáŒ∏,p ‚àáŒ∏,p H(Œ¶œÑ,H (Œ∏, p))F (œÑ ) = 0
as desired by simply using A> = ‚àíA.
Time-Reversibility ‚Äì However, crucially it is not the case that the Hamilton equations are time-reversible
in the traditional sense of canonical Hamiltonian dynamics.
1

Lemma 2. If (Œ∏(t), p(t)) is a solution to the non-canonical dynamics:

 


d Œ∏(t)
E
F ‚àáŒ∏ H(Œ∏(t), p(t))
=
‚àíF> G ‚àáp H(Œ∏(t), p(t))
dt p(t)
|
{z
}

(7)

A

e p
e (t)) = (Œ∏(‚àít), ‚àíp(‚àít)) is a solution to the modified non-canonical dynamics:
then (Œ∏(t),
#
"

 
e p(t))
e
‚àáe
H(
Œ∏(t),
d Œ∏(t)
‚àíE
F
Œ∏
=
e p
‚àíF> ‚àíG ‚àáe
e (t)
dt p
e (t))
H(Œ∏(t),
p
|
{z
}
e
A

(8)

e which reduces to the traditional time-reversal
if H(Œ∏, p) = H(Œ∏, ‚àíp). In particular if E = G = 0 then A = A,
symmetry of canonical Hamiltonian dynamics.
Proof. A direct calculation yields

 

  d
d Œ∏ÃÉ(t)
‚àíE‚àáŒ∏ H(Œ∏(‚àít)) ‚àí F‚àáp H(Œ∏(‚àít))
‚àí Œ∏(‚àít)
=
= ddt
‚àíF> ‚àáŒ∏ H(Œ∏(‚àít)) + G‚àáp H(Œ∏(‚àít))
dt pÃÉ(t)
dt p(‚àít)
 



‚àíE
F
‚àíE‚àáŒ∏ÃÉ H(Œ∏ÃÉ(t)) + F‚àápÃÉ H(Œ∏ÃÉ(t))
‚àáŒ∏ÃÉ H(Œ∏ÃÉ(t))
=
=
‚àíF> ‚àíG ‚àápÃÉ H(Œ∏ÃÉ(t))
‚àíF> ‚àáŒ∏ÃÉ H(Œ∏ÃÉ(t)) ‚àí G‚àápÃÉ H(Œ∏ÃÉ(t))
|
{z
}
AÃÉ

1.1

Non-Canonical Dynamics Variable Augmentation

As remarked in the main text it is necessary to flip the E and G matrices at the end of a deterministic
simulation of the Hamiltonian dynamics in order to render the proposal time-reversible which is in turn
necessary to satisfy detailed balance. This is crucial for the correctness of the algorithm especially when an
approximate simulation of the dynamics is used (as is always often the case).
In particular, say that we wish to use Œ¶A
œÑ,H (Œ∏, p) as a transition kernel with fixed, non-zero values of E = E0
and G = G0 . We first augment the state-space by placing a symmetric, binary distribution independently over
E and G such that p(E = E0 ) = p(E = ‚àíE0 ) = 1/2 and p(G = G0 ) = p(G = ‚àíG0 ) = 1/2, independently of
Œ∏, p:
œÅ(Œ∏, p, E, G) ‚àù e‚àíH(Œ∏,p) p(E)p(G).

(9)

Importantly, this augmentation leaves the distribution over Œ∏, p intact when E and G are marginalized out.
Just as applying the momentum flip operator, Œ¶p : (Œ∏, p, E, G) ‚Üí (Œ∏, ‚àíp, E, G), is a deterministic, energypreserving, volume-preserving transformation, the E, G flip operators, Œ¶E : (Œ∏, p, E, G) ‚Üí (Œ∏, p, ‚àíE, G)
and Œ¶G : (Œ∏, p, E, G) ‚Üí (Œ∏, p, E, ‚àíG), are also deterministic, energy-preserving, volume-preserving transformations that leave (9) invariant for this particular augmentation with p(E) and p(G). We can now
e A (Œ∏, p), composed of simulating the Hamiltonian flow as Œ¶A (Œ∏, p) plus
build a self-inverse operator Œ¶
œÑ,H
œÑ,H
Œ¶E ‚ó¶ Œ¶G ‚ó¶ Œ¶p , a flip of p, E, G, as:
e A (Œ∏, p) = Œ¶E ‚ó¶ Œ¶G ‚ó¶ Œ¶p ‚ó¶ Œ¶A (Œ∏, p)
Œ¶
œÑ,H
œÑ,H

(10)

e A (Œ∏, p). Œ¶
e A (Œ∏, p) can now be used as the
Now we have constructed a deterministic, self-inverse map Œ¶
œÑ,H
œÑ,H
proposal for a reversible MCMC algorithm.
An important point to note is that our choice of variable augmentation strategy, namely augmenting with
binary distribution, is certainly not unique. However, it is perhaps the most natural and simplest choice
which avoids the repetitive computation of matrix exponentials/diagonalizations since the approximate flow
detailed in Section 2.2 will only need to compute matrix exponentials once upfront for ¬±G.
2

1.2

Mass Preconditioning Proofs

A common variation on standard HMC dynamics is to set the kinetic energy term in the Hamiltonian H(Œ∏, p)
to 12 p> M‚àí1 p for some symmetric positive-definite matrix M, and sample the initial momentum variable
p from the corresponding distribution N (0, M). However, we can contextualize preconditioning using a
non-canonical A matrix in the following manner:
Lemma 3. i) Preconditioned HMC with momentum variable p ‚àº N (0, M) in the (Œ∏, p) coordinates, is
exactly equivalent to simulating non-canonical HMC with p0 = M‚àí1/2 p ‚àº N (0, I) and the non-canonical
matrix:


0
M1/2
A=
‚àí(M1/2 )>
0
and then transforming back to (Œ∏, p) coordinates using p = M1/2 p0 . Here M1/2 is a Cholesky factor for M.
ii) On the other hand if we apply a change of basis (via an invertible matrix F) to our coordinates
Œ∏0 = F‚àí1 Œ∏, simulate HMC in the (Œ∏0 , p) coordinates, and transform back to the original basis using F, this is
exactly equivalent to non-canonical HMC with


0
F
A=
‚àíF> 0
Proof. We first prove the equivalence regarding the change of basis in momentum space. Under the M mass
matrix variant of HMC, p is drawn from a N (0, M) distribution, and the dynamics of Œ∏, p are then given by
  

d Œ∏
M‚àí1 p
=
‚àí‚àáŒ∏ U (Œ∏)
dt p
Denoting the upper-triangular Cholesky factor of M‚àí1 by M‚àí1/2 , and introducing a new variable p0 =
M‚àí1/2 p, we obtain the following dynamics for the joint variable (Œ∏, p0 ):
 

 
 


d Œ∏
d
Œ∏
(M‚àí1/2 )> p0
0
(M‚àí1/2 )> ‚àáŒ∏ U (Œ∏)
=
=
=
p0
‚àíM‚àí1/2 ‚àáŒ∏ U (Œ∏)
‚àíM‚àí1/2
0
dt p0
dt M‚àí1/2 p
Further, note that if the marginal distribution of p is N (0, M), then under this change of variables p0 has the
marginal distribution N (0, I). Thus, simulating canonical HMC with a non-identity mass matrix is equivalent
to making a change of basis in momentum space, simulating non-canonical HMC with a particular choice of
non-canonical A matrix, and finally reverting back to the original basis.
We now prove the equivalence regarding the change of basis in Œ∏ space, which follows similarly. Consider
non-canonical HMC on the state-momentum pair (Œ∏, p), with the antisymmetric matrix A taking the particular
form


0
F
A=
‚àíF> 0
The states Œ∏, p obtained from this algorithm are equal to those obtained by first changing basis to Œ∏0 = F‚àí1 Œ∏,
then simulating standard HMC dynamics for the pair (Œ∏0 , p) with respect to the Hamiltonian
1
H 0 (Œ∏0 , p) = U 0 (Œ∏0 ) + p> p
2
1
= U (FŒ∏) + p> p
2
and then reverting to the original basis as Œ∏ = FŒ∏0 . To see this, first note that if we denote the distribution
on the coordinates Œ∏ corresponding to the potential U by œÄ(Œ∏) = e‚àíU (Œ∏) , then the corresponding distribution
on the coordinates Œ∏0 is given by œÄ 0 , where
œÄ 0 (Œ∏0 ) = det(F)œÄ(FŒ∏0 )
The corresponding potential U 0 is therefore given by
U 0 (Œ∏0 ) = U (FŒ∏0 )
3

Running canonical HMC dynamics targeting the Hamiltonian H 0 yields the dynamics:
  

d Œ∏0
p
=
‚àí‚àáŒ∏0 U (Œ∏0 )
dt p
But note then that the dynamics of the original coordinates are then given by:
 

 
 

 
d FŒ∏0
d Œ∏
Fp
Fp
Fp
=
=
=
=
‚àí‚àáŒ∏0 U (Œ∏0 )
‚àí‚àáŒ∏0 U (FŒ∏)
‚àí(F> )‚àáŒ∏ U (Œ∏)
dt p
dt p



0
F ‚àáŒ∏ U (Œ∏)
=
p
‚àíF> 0
which are exactly a special case of non-canonical HMC dynamics described above.

2

Magnetic HMC (MHMC)

Here we provide proofs related to the dynamics of magnetic HMC and it‚Äôs symplectic integration scheme.

2.1

Non-Canonical Dynamics and Magnetism

We first establish the connection between the particular subcase of non-canonical Hamiltonian dynamics
where


0
I
A=
‚àíI G
and Newton‚Äôs law for a charged particle coupled to a magnetic field.
Lemma 4. In 3-dimensions the non-canonical Hamiltonian dynamics, with Hamiltonian H(Œ∏, p) = U (Œ∏) +
1 >
2 p p, correspond to simulating the differential equations:
 


  

d Œ∏
‚àáŒ∏ H
0
I ‚àáŒ∏ U (Œ∏)
0
I
‚â°
(11)
=
‚àíI G
p
‚àíI G ‚àáp H
dt p
| {z }
| {z }
A

where

A

Ô£Æ

‚àíb3
0
b1

0
G = Ô£∞ b3
‚àíb2

Ô£π
b2
‚àíb1 Ô£ª
0

are equivalent to theÔ£Æ Newtonian
mechanics of a charged particle (with unit mass and charge) coupled to a
Ô£π
b1
~ = Ô£∞b2 Ô£ª which take the form:
magnetic field B
b3
d2 Œ∏
dŒ∏ ~
= ‚àí‚àáŒ∏ U (Œ∏) +
√óB
2
dt
dt
where Œ∏ is simply a 3-dimensional vector and √ó the cross-product.

(12)

Proof. If we let Œ∏ and p denote our position and momentum coordinates in 3 dimensions then Newton‚Äôs law
for a charged particle in a magnetic field (with m = q = 1) is:
d2 Œ∏
dŒ∏ ~
= ‚àí‚àáŒ∏ U (Œ∏) +
√óB
2
dt
dt

(13)

Defining momentum canonically as dŒ∏
dt = p we have:
  
 
 


d Œ∏
p
p
0
I ‚àáŒ∏ U (Œ∏)
=
=
‚â°
~
‚àí‚àáŒ∏ U (Œ∏) + Gp
‚àíI G
p
‚àí‚àáŒ∏ U (Œ∏) + dŒ∏
dt p
dt √ó B
| {z }
A

4

(14)

We now show that the dynamics used in magnetic HMC cannot be reproduced by simply choosing a
different smooth Hamiltonian, H 0 (Œ∏, p) and using the canonical A matrix:


0 I
A=
‚àíI 0
to generate the dynamics.
Lemma 5. The non-canonical Hamiltonian dynamics with magnetic A and Hamiltonian H(Œ∏, p) = U (Œ∏) +
1 >
2 p p cannot be obtained using canonical Hamiltonian dynamics for any choice of smooth Hamiltonian.
Proof. Consider the ODEs corresponding to non-canonical dynamics with magnetic A and H(Œ∏, p) =
U (Œ∏) + 12 p> p:
  

 

d Œ∏
0
I ‚àáŒ∏ U (Œ∏)
p
=
=
.
(15)
‚àíI G
p
‚àí‚àáŒ∏ U (Œ∏) + Gp
dt p
Assume, to obtain a contradiction, that these canonical Hamiltonian dynamics can be reproduced for some
choice of smooth H 0 (Œ∏, p) and canonical A matrix (i.e. E = G = 0, F = I):
  

 

d Œ∏
0 I ‚àáŒ∏ H 0 (Œ∏, p)
p
=
=
.
(16)
‚àíI 0 ‚àáp H 0 (Œ∏, p)
‚àí‚àáŒ∏ U (Œ∏) + Gp
dt p
This implies:

 


 

‚àáp H 0 (Œ∏, p)
p
‚àáŒ∏ ‚àáp H 0 (Œ∏, p)
0
=
=‚áí
=
.
‚àáŒ∏ H 0 (Œ∏, p)
‚àáŒ∏ U (Œ∏) ‚àí Gp
‚àáp ‚àáŒ∏ H 0 (Œ∏, p)
‚àíG

(17)

However, as long as the 2nd-order mixed partial derivatives are continuous they must be equal; so the
conclusion follows.

2.2

Symplectic Integrator for Magnetic Dynamics

We begin by considering the symmetric splitting:
H(Œ∏, p) = U (Œ∏)/2 + pT p/2 + U (Œ∏)/2
| {z } | {z } | {z }
H1 (Œ∏)

H2 (p)

(18)

H1 (Œ∏)

The corresponding non-canonical dynamics for the sub-Hamiltonians H1 (Œ∏) and H2 (p) are:
  

 

d Œ∏
E
F ‚àáŒ∏ U (Œ∏)/2
E‚àáŒ∏ U (Œ∏)/2
=
=
0
‚àíF> G
‚àíF> ‚àáŒ∏ U (Œ∏)/2
dt p
{z
}
|

(19)

A

and
  
  

d Œ∏
E
F 0
Fp
=
=
.
Gp
‚àíF> G p
dt p
|
{z
}

(20)

A

A
We denote the corresponding flows by Œ¶A
,H1 (Œ∏) and Œ¶,H2 (p) respectively. The flow in (19) is generally not
explicitly tractable unless we take E = 0 ‚Äì in which case it is solved by an Euler translation as for standard
Hamiltonian dynamics.
Crucially, the flow in (20) is a linear differential equation and hence analytically integrable. Without loss
of generality, we restrict ourselves to the case F = I (the case for general F follows similarly). The dynamics
associated with the flow H2 (p) introduced in Lemma 4 become

 

d Œ∏(t)
p(t)
=
Gp(t)
dt p(t)

5

with initial condition (Œ∏0 , p0 ). Using the power series representation of the matrix exponential, the second
differential equation for p may be integrated analytically to yield the following flow in p-space:
p(t) = exp(Gt)p0
Substituting this result into the differential equation for Œ∏ yields
dŒ∏
= exp(Gt)p0
dt
If G is invertible then once again using the power series representation of the matrix exponential and
rearranging yields the solution
  

Œ∏
Œ∏ + G‚àí1 (exp(G) ‚àí I)p
Œ¶,H2 (p)
=
p
exp(G)p
If G is not invertible, then slightly more care must be taken to first diagonalize G and separate its
invertible/singular components. Since G is strictly antisymmetric it can be written as iH where H is a
Hermitian matrix. Thus it can be diagonalized over C as:

  >

 Œõ 0 UŒõ
G = UŒõ U0
0 0 U0>
 >


UŒõ
where Œõ is a diagonal submatrix consisting of the nonzero eigenvalues of G. UŒõ U0 and
are unitary
U0>
matrices where the columns of UŒõ are the eigenvectors of G corresponding to its nonzero eigenvalues while
the columns of U0 are the eigenvectors of G corresponding to its zero eigenvalues. Even if G is not invertible
we still have:
p(t) = exp(Gt)p0
However it is more convenient to represent the matrix exponential as:

  >

 exp(Œõt) 0 UŒõ
exp(Gt) = UŒõ U0
0
I U0>
Substituting this result into the differential equation for Œ∏, this representation of exp(Gt) implies the
non-identity block can be handled as in the invertible case while the I block follows trivially to give:

  >

 Œõ‚àí1 (exp(Œõt) ‚àí I) 0 UŒõ
U
U
Œ∏(t) = Œ∏0 + Œõ
p
0
0
tI U0> 0
Note that if G = 0 then the flow map will simply reduce to an Euler translation as in ordinary HMC. We
can also combine the ideas of Section 1.2 to obtain a preconditioned, magnetic HMC algorithm corresponding
to a general A-matrix of the form


0
F
‚àíF> G
Dealing with a non-zero E becomes more subtle, since the corresponding sub-Hamiltonian is no longer
exactly integrable under the splitting construction. In order to exactly integrate this sub-block a more costly
implicit integrator is needed.

2.3

Integration Error of Magnetic HMC

Since we are using a symmetric, leapfrog splitting scheme for magnetic HMC that exactly integrates each
sub-Hamiltonian we obtain identical error scaling to the leapfrog integrator applied to canonical HMC. Indeed,
symplectic integrators are well-known to have many nice error properties in general and so perhaps this result
is not so surprising [3].

6

Lemma 6. The symplectic leapfrog-like integrator for magnetic HMC will have the same local (‚àº O(3 ))
and global (‚àº O(2 )) error scaling (over œÑ ‚àº L steps), as the canonical leapfrog integrator of standard HMC
if the Hamiltonian is separable.
Proof. Note that for the parametrization of A corresponding to magnetic HMC the Hamiltonian vector field
~ = ‚àáp H‚àáŒ∏ + (‚àí‚àáŒ∏ + G‚àáp H)‚àáp ‚â° A
~ will generate the exact flow corresponding to exactly simulating
~ +B
H
3
the dynamics. We obtain an O( ) local error by simply exploiting the separability of the Hamiltonian.
The leapfrog integration scheme splits the Hamiltonian as: H(Œ∏, p) = H1 (Œ∏) + H2 (p) + H1 (Œ∏) and exactly
integrates each sub-Hamiltonian so:
 
 


~ ‚ó¶ exp A
~ ‚ó¶ exp  B
~
Œ¶frog
=
Œ¶
‚ó¶
Œ¶
‚ó¶
Œ¶
=
exp
B
(21)
,H
(Œ∏)
,H
(p)
,H
(Œ∏)
1
2
1
,H
2
2
(22)
Via repeated applications of the Baker-Campbell-Hausdorff formula [3] obtain:


 
2
~ ‚ó¶ exp A
~ + B
~ +  [A,
~ B]
~ + O(3 ) =
exp
B
2
2
2


2
2
~
~ + B
~ +  [A,
~ B]
~ + 1 [  B,
~ A
~ + B
~ +  [A,
~ B]]
~
exp
B + A
+ O(3 ) =
2
2
2
2 2
2
2


 
2
2
2
~ B]
~ +  [B,
~ A]
~ +  [B,
~ B]
~ + O(3 ) = exp H
~ + O(3 )
~ +  [A,
exp H
4
4
8

(23)
(24)
(25)

where we have used the antisymmetry of the commutator. The global error scaling, for an integration time of
œÑ = L follows straightforwardly:

 
 

L
~ ‚ó¶ exp A
~ ‚ó¶ exp  B
~
Œ¶frog
B
œÑ,H = exp
2
2

 
L
3
~ + O( )
= exp H


~ + LO(2 )
= exp LH
 
~ + œÑ O(2 )
= exp œÑ H
 
~ + O(2 )
= exp œÑ H

(26)
(27)
(28)
(29)
(30)

as desired.

3

Section 6 Experimental Details

Here we provide relevant experimental details for some of the Experiments presented in the main text.

3.1

Gaussians

In both experiments the reported autocorrelation measures are averaged over all coordinates as well as over
100 independent runs of the HMC/MHMC chains.
3.1.1

2D Gaussian

For the uncorrelated, ill-conditioned 2D Gaussian experiment presented in the main text the magnetic G
component only has one non-zero parameter which was set to g = .2.

7

3.1.2

10D Gaussian

For the uncorrelated, ill-conditioned 10D Gaussian experiment presented in the main text, the G matrix was
set to encourage the flow of momentum between the directions of large marginal variance with covariance
eigenvalues 106 and the remaining 8 directions of directions of small marginal variance with covariance
eigenvalues of 1. We denote the directions of large marginal variance as x1 , x2 , and the other 8 directions
of directions of small marginal variance as xi . G was set such that G1i = G2i = g, Gi1 = Gi2 = ‚àíg and
G12 = G21 = 0 for g = .2.

3.2

Mixture of Gaussians

The superior mixing of MHMC relative to HMC in this example holds true for a wide range of (, L) settings
as we can see by looking at the maximum mean discrepancy as a function of the number of samples in both
Figures 1 and 2.
30

30

g = 0.0
g = 0.05
g = 0.1
g = 0.15

g = 0.0
g = 0.05
g = 0.1
g = 0.15

25

Maximum Mean Discrepancy

Maximum Mean Discrepancy

25

20

15

10

5

0

20

15

10

5

0
2000

4000

6000

8000

10000 12000 14000

2000

Number of Samples

4000

6000

8000

10000 12000 14000

Number of Samples

Figure 1: Left: MMD vs. Number of Samples for ( = 1.5, L = 33). The acceptance rate was ‚àº .74 for all g.
Right: MMD vs. Number of Samples for ( = 1.9, L = 40). The acceptance rate was ‚àº .43 for all g = 0 and
‚àº .34 for all non-zero g. In both diagrams g denotes the non-zero component of the magnetic field.

30

30

g = 0.0
g = 0.05
g = 0.1
g = 0.15

g = 0.0
g = 0.05
g = 0.1
g = 0.15

25

Maximum Mean Discrepancy

Maximum Mean Discrepancy

25

20

15

10

5

0

20

15

10

5

0
2000

4000

6000

8000

10000 12000 14000

2000

Number of Samples

4000

6000

8000

10000 12000 14000

Number of Samples

Figure 2: Left: MMD vs. Number of Samples for ( = 1.0, L = 50). The acceptance rate was ‚àº .87 for all g.
Right: MMD vs. Number of Samples for ( = 0.5, L = 110). The acceptance rate was ‚àº .95 for all g. In both
diagrams g denotes the non-zero component of the magnetic field.
We found that tuning the parameters (, L) via Bayesian optimization often resulted in worse performance
for ordinary HMC since the values found for (, L) were too conservative to encourage exploration between
both modes. Moreover, more aggressive choices for (, L) for ordinary HMC led to a sharp drop in acceptance
rate and significantly worse performance.

8

3.3

Gaussian Funnel

In this additional experiment, we consider the Gaussian funnel of [4] with density
p(x, v) = Œ†ni=1 N (xi |0, e‚àív )N (v|0, 32 )
in 10+1 dimensions (i.e. n = 10). This density illustrates the pathological correlation present in many
hierarchical models between x, a vector of low-level parameters, and v, a hyperparameter controlling their
variability. As noted in [1, 5], Riemannian HMC methods, which incorporate local curvature information of
the target, are well-suited to this problem as they help the dynamics traverse the energy surface which rapidly
changes as a v varies. HMC (as well as MHMC) do not exploit curvature information and will have more
difficulty exploring the v direction due to the rapid variation in density ‚Äì see [1] for a detailed discussion.
Despite this difficulty, we might intuitively expect that introducing a ‚Äúcurl‚Äù term into the entries of G
which couple each xi and v could increase exploration of the dynamics since these variables are nonlinearly
correlated. In order to encourage the periodic flow of momentum between the marginal direction v and the
coordinates xi the G matrix was set such that Gvi = g, Giv = ‚àíg, Gij = 0 with g = .2. To investigate this,
we generated 10000 samples from both HMC and MHMC, discarding 1000 burn-in samples and computed
the minimum effective sample size across x and v and bias in the moments of the v parameter similar to the
set-up in [5] for various , L (see Table 1). We report results averaged over 100 different runs of the Markov
chains.
Table 1: Comparison of HMC and MHMC targeting the Gaussian funnel for a variety of leapfrog steps
algorithm

settings

time (s)

min ESS(x, v)

min ESS(x, v)/s

MSE(E[v], E[v 2 ])

HMC

 = 0.05, L = 100

225

414, 85

1.84, 0.38

.59, 1.57

MHMC

 = 0.05, L = 100

270

463, 97

1.71, 0.36

.29, 1.17

HMC

 = 0.05, L = 300

705

1342, 118

1.90, 0.17

.35, 1.15

MHMC

 = 0.05, L = 300

837

1554, 122

1.86, 0.15

.15, 1.05

We find that adding the magnetic field component decreases the bias in the moments and marginally
increases the ESS, although both samplers struggle to explore the full target density, as the relatively low
ESS figures indicate. Further details and experiments are provided in the Appendix.
Recall the density of the Gaussian funnel p(x, v) = Œ†ni=1 N (xi |0, e‚àív )N (v|0, 32 ). In order to encourage
the periodic flow of momentum between the marginal direction v and the coordinates xi the G matrix was
set such that Gvi = g, Giv = ‚àíg, Gij = 0 with g = .2. Moreover the reported results were averaged over 100
different runs of the Markov chains.

4

MHMC Proposals and Dynamics

In this section, we provide illustrations of the proposal distributions of MHMC in simple low-dimensional
settings, to aid intuition and demonstrate the divergence of its behaviour from standard HMC.

4.1

Gaussian Densities

We first consider the case of an isotropic Gaussian target, and illustrate the proposal distribution

 of standard
E F
HMC, as well as MHMC with a variety of settings for the skew-symmetric matrix A =
- see Figure
F G
3. As in previous sections, we denote the off-diagonal element of the G matrix by g. We also provide proposal
plots for an anisotropic Gaussian target distribution - see Figure 4.

4.2

Banana Density

We also provide proposal illustrations for the banana density of [2], as shown in Figure 5.

9

(a) Standard HMC (g=0)

(b) MHMC (g=0.5)

(c) MHMC (g=1.0)

(d) MHMC (g=2.0)

(e) MHMC (g=3.0)

(f) MHMC (g=4.0)

Figure 3: HMC and MHMC proposals for an isotropic Gaussian target.

(a) Standard HMC (g=0)

(b) MHMC (g=0.5)

(c) MHMC (g=1.0)

(d) MHMC (g=2.0)

(e) MHMC (g=3.0)

(f) MHMC (g=4.0)

Figure 4: HMC and MHMC proposals for an anisotropic Gaussian target.

10

(a) Standard HMC (g=0)

(b) MHMC (g=0.1)

(c) MHMC (g=0.2)

(d) MHMC (g=0.3)

(e) MHMC (g=0.4)

(f) MHMC (g=0.5)

Figure 5: HMC and MHMC proposals for the banana density target.

11

References
[1] Michael Betancourt and Mark Girolami. Hamiltonian Monte Carlo for Hierarchical Models. CRC Press,
Boca Raton, FL, 2015.
[2] Heikki Haario, Eero Saksman, and Johanna Tamminen. Adaptive proposal distribution for random walk
metropolis algorithm. Computational Statistics, 14(3), 1999.
[3] Ernst Hairer, Marlis Hochbruck, Arieh Iserles, and Christian Lubich. Geometric Numerical Integration.
Oberwolfach Reports, pages 805‚Äì882, 2006.
[4] Radford M. Neal. Slice Sampling: Rejoinder, 2003.
[5] Yichuan Zhang and Charles Sutton. Semi-separable Hamiltonian Monte Carlo for Inference in Bayesian
Hierarchical Models. In Advances in Neural Information Processing Systems, pages 10‚Äì18, 2014.

12

